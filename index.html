<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页</title>
</head>

<body>
    <div>
        <div id="time"></div>
        <button onclick="refreshLoc()">loc</button>
        <button onclick="switchLoc()">switch</button>
        <div id="loc" style="white-space: pre-wrap;"></div>
        <div id="floc" style="white-space: pre-wrap;"></div>
        <hr>
        <div id="localstorage" style="white-space: pre-wrap;">localStorage:<ul></ul></div>
        <hr>
        <input type="checkbox" name="awaking" id="awaking">
        <label for="awaking">唤醒</label>
        <div id="links">
            <a href="spaceship.html">小火箭</a>
            <a href="waterMark.html">水印制作</a>
            <a href="bili.html">bilibili</a>
            <a href="百人万元模拟_ECharts.html">百人万元模拟_ECharts</a>
        </div>
    </div>
    <script>
        setInterval(() => {
            let x = new Date();
            document.getElementById('time').innerText = x.toLocaleString();
        }, 1000);


        // 显示localStorage
        function rm(key) {
            localStorage.removeItem(key);
            document.getElementById(key).remove();
        }
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            let value_str = localStorage.getItem(key);
            try {
                let value_obj = JSON.parse(value_str);
                value_str = JSON.stringify(value_obj, null, 4);
                console.log(key, value_obj);
            } catch (error) {
                console.log(key, value_str);
            }
            document.querySelector('#localstorage>ul').innerHTML += (
                `<li id='${key}'>${key}: ${value_str} <button onclick="rm('${key}')">删除</button></li>`
            )
        }

        // 唤醒状态切换
        awaking = document.getElementById('awaking');
        async function awake(){
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.onrelease = () => {
                    if (awaking.checked) {
                        console.log('发生非主动释放')
                        awake();
                    }
                };
                console.log('唤醒成功');
            } catch (error) {
                awaking.checked = false;
                console.log('唤醒失败');
            }
        }
        awaking.addEventListener('change', () => {
            if (awaking.checked) {
                awake();
            } else {
                wakeLock.release();
                console.log('释放成功');
            }
        });
        awaking.click();
        // 返回页面后恢复唤醒状态
        window.addEventListener('visibilitychange', async () => {
            console.log(document.visibilityState);
            if (document.visibilityState === 'visible') {
                if (awaking.checked) awake();
            }
        });
    </script>
    <script>
        function mkUrl(obj) {
            let url = obj.base;
            let keys = Object.keys(obj.kvs);
            for (let i = 0; i < keys.length; i++) {
                let k = keys[i];
                let v = obj.kvs[k];
                if (i == 0) {
                    url += '?';
                }
                url = url.concat(k, '=', v);
                if (i != keys.length - 1) {
                    url += '&';
                }
            }
            return url
        }

        async function gaoDeLoc(gaodeLntLatStr) {
            let max_radius = 500;
            let requestObj = {
                base: 'https://restapi.amap.com/v3/geocode/regeo',
                kvs: {
                    key: '22f56bdaf27f7d13215d03984880ab26',
                    location: gaodeLntLatStr,
                    radius: 0,
                }
            }
            let resObj = null;
            while(1){
                resObj = await fetch(mkUrl(requestObj)).then((res) => res.json())
                console.log(`range ${requestObj.kvs.radius} get loc_name res ${resObj}`)
                if(resObj.status == 1) break;
                if (requestObj.kvs.radius <= max_radius) {
                    requestObj.kvs.radius += 50;
                } else break;
            }
            console.log(resObj)
            return resObj
        }

        async function gaoDeLntLat(longitude, latitude) {
            longitude = longitude.toFixed(6);
            latitude = latitude.toFixed(6);
            let requestObj = {
                base: 'https://restapi.amap.com/v3/assistant/coordinate/convert',
                kvs: {
                    key: '22f56bdaf27f7d13215d03984880ab26',
                    locations: `${longitude},${latitude}`,
                    coordsys: 'gps',
                }
            }
            gaodeLntLatObj = await fetch(mkUrl(requestObj)).then((res) => res.json())
            console.log(gaodeLntLatObj)
            return gaodeLntLatObj
        }

        function refreshLoc() {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    console.log(position);
                    locEl.innerHTML = JSON.stringify(position, null, 4);
                    
                    gdllobj = await gaoDeLntLat(position.coords.longitude, position.coords.latitude)
                    locEl.innerHTML += '\ngaoDeLntLat: ' + JSON.stringify(gdllobj, null, 4);
                    
                    resObj = await gaoDeLoc(gdllobj.locations)
                    locEl.innerHTML += '\ngaoDeLoc: ' + JSON.stringify(resObj, null, 4);
                    
                },
                (positionError) => {
                    console.log(positionError.code, positionError.message)
                },
                {
                    enableHighAccuracy: true,
                }
            );
        }

        locEl = document.getElementById('loc');
        flocEl = document.getElementById('floc');
        flocEl.style.display = 'none';
        flocEl.innerHTML = '\n'.repeat(100);
        refreshLoc();
        function switchLoc() {
            locEl.style.display = locEl.style.display == 'none' ? 'block' : 'none';
            flocEl.style.display = flocEl.style.display == 'none' ? 'block' : 'none';
        }
        // setInterval(refreshLoc, 5000);

    </script>
</body>

</html>